<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ£ Sushida for Excelï¼ˆ60ç§’ï¼‰- Sushida UI</title>
  <style>
    :root{
      --w: 820px;
      --h: 700px;

      --wood1:#d8ad73;
      --wood2:#c79356;
      --frame:#3a240f;

      --tatami:#a9b66a;
      --table:#e2b36e;

      --panel: rgba(18, 10, 4, 0.78);
      --panel-border: rgba(255,255,255,0.92);

      --ink:#1b120a;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:#1a1a1a;
      display:grid;
      place-items:center;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .game-frame{
      width: var(--w);
      height: var(--h);
      border: 10px solid var(--frame);
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 12px 26px rgba(0,0,0,0.45);
      position: relative;
      background: linear-gradient(180deg, var(--tatami) 0 38%, var(--table) 38% 100%);
    }

    /* æœ¨ç›®ã£ã½ã„ãƒãƒ¼ï¼ˆä¸Š/ä¸‹ï¼‰ */
    .wood-bar{
      background:
        linear-gradient(180deg, var(--wood1), var(--wood2)),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.06) 0 6px, rgba(0,0,0,0.02) 6px 12px);
      border-color: rgba(0,0,0,0.15);
    }

    /* â€œç”»é¢æ â€ã£ã½ã„å››éš…ã®é‹²ï¼ˆé›°å›²æ°—ï¼‰ */
    .pin{
      position:absolute;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff, #caa86f 40%, #7a5a2c 100%);
      box-shadow: inset 0 1px 1px rgba(255,255,255,0.4), 0 2px 2px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .pin.tl{ top: 6px; left: 6px; }
    .pin.tr{ top: 6px; right: 6px; }
    .pin.bl{ bottom: 6px; left: 6px; }
    .pin.br{ bottom: 6px; right: 6px; }

    /* ========== TOP ========== */
    .top-bar{
      height: 90px;
      border-bottom: 4px solid rgba(0,0,0,0.15);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 18px;
    }

    .time-left{
      display:flex;
      align-items:baseline;
      gap: 10px;
      color: var(--ink);
      text-shadow: 0 1px 0 rgba(255,255,255,0.35);
      user-select:none;
    }
    .time-left .time-label{ font-size: 24px; font-weight: 900; }
    .time-left .time-value{ font-size: 56px; font-weight: 900; letter-spacing: 1px; }
    .time-left .time-unit{ font-size: 22px; font-weight: 900; }


/* å•é¡Œï¼ˆ1å•ï¼‰ã®æ®‹ã‚Šæ™‚é–“ï¼šå…¨ä½“ã‚¿ã‚¤ãƒãƒ¼ã®å³å´ã«å°ã•ãè¡¨ç¤º */
.qtime{
  display:inline-flex;
  align-items:baseline;
  gap: 6px;
  margin-left: 10px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.35);
  border: 1px solid rgba(0,0,0,0.14);
  color: rgba(27,18,10,0.85);
  user-select:none;
}
.qtime .qtime-label{ font-size: 12px; font-weight: 900; letter-spacing: 0.2px; }
.qtime .qtime-value{ font-size: 18px; font-weight: 900; min-width: 18px; text-align:right; font-variant-numeric: tabular-nums; }
.qtime .qtime-unit{ font-size: 12px; font-weight: 900; }

    .top-actions{ display:flex; align-items:center; gap: 10px; }

    .btn{
      appearance:none;
      border: 2px solid rgba(0,0,0,0.25);
      background: linear-gradient(#f2c680, #d59b57);
      color: #2a1609;
      font-weight: 900;
      padding: 10px 16px;
      border-radius: 10px;
      box-shadow: 0 3px 0 rgba(0,0,0,0.25);
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.25); }

    /* ========== STAGE ========== */
    .stage{
      height: calc(var(--h) - 90px - 90px);
      position: relative;
      padding-top: 26px;
    }

    /* æœºã®æ¿ã£ã½ã„ç·š */
    .stage::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      top:38%;
      bottom:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          90deg,
          rgba(0,0,0,0.06) 0 2px,
          rgba(255,255,255,0.04) 2px 120px
        );
      mix-blend-mode: multiply;
      opacity: 0.25;
    }

    .sushi-area{
      display:flex;
      justify-content:center;
      margin-top: 16px;
      position: relative;
      z-index: 1;
    }
    .sushi-img{
      width: 310px;
      height: auto;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,0.25));
      user-select:none;
    }

    /* å•é¡Œã‚¨ãƒªã‚¢ï¼šåˆ¤å®šï¼ˆå·¦ï¼‰ï¼‹é»’ãƒ‘ãƒãƒ«ï¼ˆå³ï¼‰ */
    .prompt-wrap{
      margin-top: 26px;
      display:flex;
      justify-content:center;
      align-items:stretch;
      gap: 12px;
      position: relative;
      z-index: 2;
    }

    .judge-box{
      width: 92px;
      min-height: 164px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap: 8px;
      background: rgba(255,255,255,0.55);
      border: 2px solid rgba(0,0,0,0.18);
      border-radius: 12px;
      color: var(--ink);
      font-weight: 900;
      user-select:none;
    }
    .judge-box .judge-label{ font-size: 16px; opacity: 0.9; }
    .judge-box .judge-value{ font-size: 18px; text-align:center; padding: 0 6px; }

    .prompt-panel{
      width: 580px;
      padding: 14px 22px 14px;
      background: var(--panel);
      border: 3px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.25);
      text-align:center;
      position: relative;
    }

    .meta-row{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
      opacity: 0.95;
      user-select:none;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.22);
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
    }

    .prompt-text{
      font-size: 32px;
      font-weight: 900;
      color: #fff;
      letter-spacing: 0.5px;
      line-height: 1.25;
      margin: 4px 0 0;
    }

    /* ã€Œé€²æ—ã€â†’ã€Œã‚¹ãƒ†ãƒƒãƒ—ã€å•é¡Œæ–‡ã®ã™ãä¸‹ */
    .step-row{
      margin-top: 10px;
      font-size: 18px;
      color: rgba(255,255,255,0.86);
      display:flex;
      justify-content:center;
      gap: 10px;
      user-select:none;
    }
    .step-row .step-label{ font-weight: 900; }
    .step-row .step-value{ font-weight: 900; }

    .sub-row{
      margin-top: 10px;
      display:flex;
      justify-content:center;
      gap: 10px;
      color: rgba(255,255,255,0.82);
      font-size: 14px;
      user-select:none;
    }
    .sub-row .sub-label{ font-weight: 900; opacity: 0.95; }

    .result-hint{
      margin-top: 10px;
      font-size: 13px;
      color: rgba(255,255,255,0.82);
      user-select:none;
    }
    /* çµ‚äº†æ™‚ã®çµæœè¡¨ç¤ºã‚’å¤§ããï¼ˆæ­£è§£æ•°/ã‚¹ã‚³ã‚¢ã‚’è¦‹ã‚„ã™ãï¼‰ */
    .result-hint.final{
      margin-top: 14px;
      font-size: 20px;
      color: rgba(255,255,255,0.94);
      line-height: 1.45;
    }
    .final-result{
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:center;
      justify-content:center;
    }
    .final-result .row{
      font-weight: 900;
    }
    .final-result .num{
      font-size: 30px;
      font-weight: 900;
      margin: 0 6px;
      font-variant-numeric: tabular-nums;
    }
    .final-result .yen-inline{
      font-size: 18px;
      font-weight: 900;
      margin-left: 2px;
    }
    .final-result .sub{
      margin-top: 2px;
      font-size: 14px;
      opacity: 0.88;
    }


    .hint-mini{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      user-select:none;
    }

    .ok{ color: #26d07c; font-weight: 900; }
    .ng{ color: #ff6b6b; font-weight: 900; }

    /* Escã§ã‚¹ã‚­ãƒƒãƒ—ï¼šå·¦ä¸‹ */
    .hint-skip{
      position:absolute;
      left: 14px;
      bottom: 14px;
      color: rgba(0,0,0,0.68);
      font-weight: 900;
      font-size: 14px;
      background: rgba(255,255,255,0.35);
      padding: 6px 10px;
      border-radius: 10px;
      user-select:none;
      z-index: 3;
    }

    /* ========== SCORE ========== */
    .score-bar{
      height: 90px;
      border-top: 4px solid rgba(0,0,0,0.15);
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 14px;
      flex-wrap: nowrap;
    }

    
/* ã€Œã‚¹ã‚³ã‚¢ã€è¡¨è¨˜ã¯éè¡¨ç¤ºï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼è‡ªä½“ã¯æ®‹ã™ï¼‰ */
.score-title{ display:none; }

/* åˆè¨ˆã¯å¼·èª¿è¡¨ç¤º */
.score-total{
  font-weight: 900;
  color: rgba(27,18,10,0.92);
  user-select:none;
  font-size: 26px;
  letter-spacing: 0.2px;
  white-space: nowrap;   /* 3æ¡ã§ã‚‚æŠ˜ã‚Šè¿”ã•ãªã„ */
  flex: 0 0 auto;        /* ãªã‚‹ã¹ãç¸®ã‚ã‚‰ã‚Œãªã„ã‚ˆã†ã« */
  line-height: 1.05;
}
.score-total .score-total-label{ margin-right: 8px; }
.score-total #score{
  font-size: 34px;
  margin: 0 4px 0 0;
  font-variant-numeric: tabular-nums;
}
.score-total .yen{
  font-size: 22px;
  margin-left: 2px;
}

    .score-meter{
      display:flex;
      gap: 6px;           /* ãƒ¡ãƒ¼ã‚¿ãƒ¼åŒå£«ã®è·é›¢ã‚’ç¸®ã‚ã‚‹ */
      flex: 1;
      min-width: 0;       /* å³å´ãŒè©°ã¾ã‚‹ã¨ãã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã‚’æŠ‘ãˆã‚‹ */
      justify-content:flex-start;
      align-items:center;
    }

    .coin{
      min-width: 124px;   /* ã•ã‚‰ã«è©°ã‚ã¦ã€åˆè¨ˆãŒ3æ¡ã§ã‚‚æŠ˜ã‚Šè¿”ã—ã«ãã */
      flex: 0 1 136px;    /* å¿…è¦ãªã‚‰å°‘ã—ç¸®ã‚ã‚‰ã‚Œã‚‹ */
      height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 0 10px;
      border-radius: 999px;
      font-weight: 900;
      color: var(--ink);
      background: rgba(255,255,255,0.55);
      border: 2px solid rgba(0,0,0,0.16);
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.35);
      user-select:none;
    }
    .coin .n{ font-variant-numeric: tabular-nums; }

    /* æœ¬å®¶ã£ã½ã„ â€œè¼ªã£ã‹â€ æ„Ÿã‚’è»½ã */
    .coin::before{
      content:"";
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.85);
      margin-right: 4px;
    }
    .c10::before{ border-color: rgba(0,160,0,0.65); }
    .c15::before{ border-color: rgba(0,120,200,0.65); }
    .c20::before{ border-color: rgba(220,0,0,0.65); }
    .c35::before{ border-color: rgba(120,120,120,0.75); }

    @media (max-width: 900px){
      .game-frame{ transform: scale(0.9); transform-origin: top center; }
    }
  </style>
</head>
<body>
  <div class="game-frame" id="frame">
    <div class="pin tl"></div><div class="pin tr"></div><div class="pin bl"></div><div class="pin br"></div>

    <header class="top-bar wood-bar">
      <div class="time-left" aria-label="remaining time">
        <span class="time-label">æ®‹ã‚Š</span>
        <span class="time-value" id="remain">60</span>
        <span class="time-unit">ç§’</span>
        <span class="qtime" title="ã“ã®å•é¡Œã®æ®‹ã‚Šæ™‚é–“">
          <span class="qtime-label">å•</span>
          <span class="qtime-value" id="qremain">5</span>
          <span class="qtime-unit">ç§’</span>
        </span>
      </div>

      <div class="top-actions">
        <button class="btn" id="start">Start</button>
        <button class="btn" id="reset">Reset</button>
      </div>
    </header>

    <main class="stage">
      <div class="sushi-area">
        <img
          class="sushi-img"
          id="sushiImg"
          alt="sushi"
          src="sushi.png"
          onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg%20xmlns=\'http://www.w3.org/2000/svg\'%20width=\'520\'%20height=\'300\'%3E%3Crect%20width=\'520\'%20height=\'300\'%20rx=\'28\'%20fill=\'%23ffffff\'%20opacity=\'0.75\'/%3E%3Cellipse%20cx=\'260\'%20cy=\'175\'%20rx=\'200\'%20ry=\'70\'%20fill=\'%23f4f4f4\'/%3E%3Cellipse%20cx=\'260\'%20cy=\'175\'%20rx=\'190\'%20ry=\'60\'%20fill=\'%23ffffff\'/%3E%3Crect%20x=\'120\'%20y=\'120\'%20width=\'140\'%20height=\'70\'%20rx=\'35\'%20fill=\'%23ffb6b6\'/%3E%3Crect%20x=\'200\'%20y=\'110\'%20width=\'160\'%20height=\'80\'%20rx=\'40\'%20fill=\'%23ff9f9f\'/%3E%3Crect%20x=\'160\'%20y=\'140\'%20width=\'230\'%20height=\'55\'%20rx=\'28\'%20fill=\'%23ffffff\'/%3E%3Ctext%20x=\'260\'%20y=\'58\'%20text-anchor=\'middle\'%20font-family=\'sans-serif\'%20font-size=\'28\'%20fill=\'%23333\'%3EPUT%20SUSHI.PNG%3C/text%3E%3C/svg%3E';"
        />
      </div>

      <section class="prompt-wrap">
        <div class="judge-box">
          <div class="judge-label">åˆ¤å®š</div>
          <div class="judge-value" id="res">-</div>
        </div>

        <div class="prompt-panel">
          <div class="meta-row">
            <span class="badge" id="lvl">level: -</span>
          </div>

          <div class="prompt-text" id="q">Startã‚’æŠ¼ã—ã¦é–‹å§‹</div>

          <div class="step-row">
            <span class="step-label">ã‚¹ãƒ†ãƒƒãƒ—</span>
            <span class="step-value mono" id="prog">0/0</span>
          </div>

          <div class="sub-row">
            <span class="sub-label">ç›´è¿‘å…¥åŠ›</span>
            <span class="mono" id="last">-</span>
          </div>

          <div class="result-hint" id="resultHint">â€»æ™‚é–“åˆ‡ã‚Œã§è‡ªå‹•çµ‚äº†ã—ã¾ã™</div>
</div>
      </section>

      <div class="hint-skip">Escã§ã‚¹ã‚­ãƒƒãƒ—</div>
    </main>

    <footer class="score-bar wood-bar">
      <div class="score-title" aria-hidden="true">ã‚¹ã‚³ã‚¢</div>
      <div class="score-total"><span class="score-total-label">åˆè¨ˆ</span><span id="score">0</span><span class="yen">å††</span></div>

      <div class="score-meter">
        <div class="coin c10">10å†† Ã—<span class="n" id="c10">00</span></div>
        <div class="coin c15">15å†† Ã—<span class="n" id="c15">00</span></div>
        <div class="coin c20">20å†† Ã—<span class="n" id="c20">00</span></div>
        <div class="coin c35">35å†† Ã—<span class="n" id="c35">00</span></div>
      </div>
    </footer>
  </div>

<script>
// =====================
// ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚ãªãŸã®æ—¢å­˜ç‰ˆã‚’â€œUIã ã‘â€å·®ã—æ›¿ãˆï¼‰
// =====================
const LIMIT_MS = 60_000;

// Excelã‹ã‚‰åæ˜ ã•ã‚ŒãŸå•é¡Œãƒãƒ³ã‚¯
const BANK = [{"level": "easy", "text": "è¡Œå…¨ä½“ã‚’é¸æŠã›ã‚ˆ", "steps": ["Shift+Space"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "åˆ—å…¨ä½“ã‚’é¸æŠã›ã‚ˆ", "steps": ["Ctrl+Space"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "é¸æŠè¡Œã‚’å‰Šé™¤ã›ã‚ˆ", "steps": ["Shift+Space", "Ctrl+-"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "é¸æŠåˆ—ã‚’å‰Šé™¤ã›ã‚ˆ", "steps": ["Ctrl+Space", "Ctrl+-"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "1è¡Œä¸Šã«è¡Œã‚’è¿½åŠ ã›ã‚ˆ", "steps": ["Shift+Space", "Ctrl+Shift++"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "ã‚»ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Œ", "steps": ["F2"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "ã‚»ãƒ«ã®å†…å®¹ã‚’ã™ã¹ã¦é¸æŠã›ã‚ˆï¼ˆç·¨é›†æ™‚ï¼‰", "steps": ["Ctrl+A"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "ç›´å‰ã®æ“ä½œã‚’å…ƒã«æˆ»ã›", "steps": ["Ctrl+Z"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "ã‚³ãƒ”ãƒ¼ã›ã‚ˆ", "steps": ["Ctrl+C"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "è²¼ã‚Šä»˜ã‘ã›ã‚ˆ", "steps": ["Ctrl+V"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "ç¾åœ¨è¡Œã®ä¸Šã«1è¡Œè¿½åŠ ã›ã‚ˆ", "steps": ["Shift+Space", "Ctrl+Shift++"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "ç¾åœ¨ã®é¸æŠã‚»ãƒ«ã®è¡Œã‚’å‰Šé™¤ã›ã‚ˆ", "steps": ["Shift+Space", "Ctrl+-"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "ç¾åœ¨ã®é¸æŠã‚»ãƒ«ã®åˆ—ã‚’å‰Šé™¤ã›ã‚ˆ", "steps": ["Ctrl+Space", "Ctrl+-"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "é¸æŠç¯„å›²ã‚’å€¤è²¼ã‚Šä»˜ã‘ã›ã‚ˆ", "steps": ["Ctrl+C", "Ctrl+Alt+V", "V", "Enter"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "è¡¨å…¨ä½“ã‚’é¸æŠã›ã‚ˆ", "steps": ["Ctrl+A"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ON/OFFã›ã‚ˆ", "steps": ["Ctrl+Shift+L"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "ã‚ªãƒ¼ãƒˆSUMã‚’å…¥ã‚Œã‚ˆ", "steps": ["Shift+Alt+="], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "ç¾åœ¨ã‚»ãƒ«ã®ä¸Šéƒ¨ã®ã‚»ãƒ«ã‚’å…¨ã¦é¸æŠã›ã‚ˆ", "steps": ["Ctrl+Shift+â†‘"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "ç¾åœ¨ã‚»ãƒ«ã‹ã‚‰å³ç«¯ã®ã‚»ãƒ«ã¾ã§å…¨ã¦é¸æŠã›ã‚ˆ", "steps": ["Ctrl+Shift+â†’"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "åŒã˜å€¤ã‚’ä¸‹æ–¹å‘ã«ã‚³ãƒ”ãƒ¼ã›ã‚ˆ", "steps": ["Ctrl+D"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "ç¾åœ¨ã®ã‚»ãƒ«ã®è¡Œå…¨ä½“ã‚’éè¡¨ç¤ºã«ã›ã‚ˆ", "steps": ["Shift+Space", "Ctrl+9"], "score": 35, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "è¡¨å…¨ä½“ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šã›ã‚ˆ", "steps": ["Ctrl+A", "Ctrl+Shift+L"], "score": 35, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "ç¾åœ¨åˆ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’é–‹ã‘", "steps": ["Alt+â†“"], "score": 35, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "ã‚»ãƒ«ã®è¡¨ç¤ºå½¢å¼ã‚’æ•°å€¤ã«ã›ã‚ˆ", "steps": ["Ctrl+1", "N", "Enter"], "score": 35, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "åˆ—å¹…ã‚’è‡ªå‹•èª¿æ•´ã›ã‚ˆ", "steps": ["Ctrl+Space", "Alt+H", "O", "I"], "score": 35, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "è¡Œã®é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã›ã‚ˆ", "steps": ["Shift+Space", "Alt+H", "O", "A"], "score": 35, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "ç¾åœ¨ã‚»ãƒ«ã‚’å«ã‚€è¡¨å…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã›ã‚ˆ", "steps": ["Ctrl+A", "Ctrl+C"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "ãƒ–ãƒƒã‚¯ã‚’ä¿å­˜ã›ã‚ˆ", "steps": ["Ctrl+S"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "æ–°ã—ã„ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã›ã‚ˆ", "steps": ["Shift+F11"], "score": 15, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "ä»Šæ—¥ã®æ—¥ä»˜ã‚’å…¥åŠ›ã›ã‚ˆ", "steps": ["Ctrl+;"], "score": 15, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "ç›´å‰ã®æ“ä½œã®ã‚„ã‚Šç›´ã—ã€ç¹°ã‚Šè¿”ã—", "steps": ["Ctrl+y"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "mid", "text": "å·¦éš£ã®ã‚»ãƒ«ã¨åŒã˜å€¤ã‚’ã‚³ãƒ”ãƒ¼ã›ã‚ˆ", "steps": ["Ctrl+R"], "score": 20, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "ç¾åœ¨ã®ã‚»ãƒ«ã®åˆ—å…¨ä½“ã‚’éè¡¨ç¤ºã«ã›ã‚ˆ", "steps": ["Ctrl+Space", "Ctrl+0"], "score": 35, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ã›ã‚ˆ", "steps": ["F12"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "ç›´å‰ã®æ“ä½œã¨åŒã˜æ“ä½œã®ç¹°ã‚Šè¿”ã—ã‚’ã›ã‚ˆ", "steps": ["F4"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "å€¤ã®æ¤œç´¢ã‚’ã›ã‚ˆ", "steps": ["Ctrl+F"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "easy", "text": "å€¤ã®ç½®æ›ã‚’ã›ã‚ˆ", "steps": ["Ctrl+H"], "score": 10, "altSteps": [], "timeLimitSec": 5.0}, {"level": "hard", "text": "ã‚»ãƒ«ã®å¡—ã‚Šã¤ã¶ã—ã‚’ç„¡ã—ã«ã›ã‚ˆ", "steps": ["alt", "H", "H", "N"], "score": 35, "altSteps": [], "timeLimitSec": 5.0}];

const $ = (id) => document.getElementById(id);

let queue = [];
let current = null;
let stepIdx = 0;

let startedAt = null;
let timerId = null;
let endTimerId = null;

let qTimerId = null;
let qRevealId = null;
let qDeadlineAt = null; // 1å•ã‚¿ã‚¤ãƒãƒ¼ã®ç· åˆ‡(è¡¨ç¤ºç”¨)

let score = 0;
let solved = 0;

// 10/15/20/35ãƒ¡ãƒ¼ã‚¿ãƒ¼ç”¨
const coinCounts = {10:0, 15:0, 20:0, 35:0};

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function defaultLevelScore(lvl){
  if (lvl === "easy") return 10;
  if (lvl === "mid") return 20;
  return 35;
}

function pointsFor(q){
  if (typeof q.score === "number" && Number.isFinite(q.score)) return q.score;
  return defaultLevelScore(q.level);
}

function pad2(n){
  return String(n).padStart(2, "0");
}

function setUI(){
  $("score").textContent = score;
  $("c10").textContent = pad2(coinCounts[10]);
  $("c15").textContent = pad2(coinCounts[15]);
  $("c20").textContent = pad2(coinCounts[20]);
  $("c35").textContent = pad2(coinCounts[35]);
}

function updateRemain(){
  const elapsed = performance.now() - startedAt;
  const remain = Math.max(0, LIMIT_MS - elapsed);
  const remainSec = Math.ceil(remain / 1000);
  $("remain").textContent = String(remainSec);

  updateQuestionRemain();

  if (remain <= 0) finish();
}

function updateQuestionRemain(){
  const el = $("qremain");
  if (!el) return;

  if (!startedAt) {
    el.textContent = "5";
    return;
  }
  if (!qDeadlineAt) {
    el.textContent = "0";
    return;
  }

  const ms = Math.max(0, qDeadlineAt - performance.now());
  const sec = Math.ceil(ms / 1000);
  el.textContent = String(sec);
}


function clearQuestionTimers(){
  if (qTimerId) clearTimeout(qTimerId);
  if (qRevealId) clearTimeout(qRevealId);
  qTimerId = null;
  qRevealId = null;
  qDeadlineAt = null;
  const el = $("qremain");
  if (el) el.textContent = "0";
}

function questionLimitMs(q){
  // 1å•ã‚ãŸã‚Šã®åˆ¶é™æ™‚é–“ã¯å¸¸ã«5ç§’
  return 5_000;
}

function formatAnswer(q){
  try { return (q && Array.isArray(q.steps)) ? q.steps.join(" â†’ ") : ""; }
  catch(e){ return ""; }
}

function onQuestionTimeout(timedOut){
  if (!startedAt) return; // game ended
  // å…¥åŠ›ã‚’æ­¢ã‚ã‚‹ï¼ˆtimeoutä¸­ã«ã‚­ãƒ¼å…¥åŠ›ãŒå…¥ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
  const ref = timedOut;
  current = null;
  stepIdx = 0;

  // å¤§ãã„å•é¡Œæ–‡ã®å ´æ‰€ã« â€œç­”ãˆâ€ ã‚’å‡ºã—ã¦è¦‹ã‚„ã™ãã™ã‚‹
  const ans = formatAnswer(ref);
  $("q").textContent = ans ? `ç­”ãˆï¼š${ans}` : "ç­”ãˆï¼š-";

  $("last").textContent = "-";
  $("res").innerHTML = `<span class="ng">æ™‚é–“åˆ‡ã‚Œ</span>`;
  $("resultHint").classList.remove("final");
  $("resultHint").textContent = "ç­”ãˆè¡¨ç¤ºä¸­â€¦";

  // å°‘ã—è¦‹ã›ã¦ã‹ã‚‰æ¬¡ã¸ï¼ˆè¡¨ç¤ºã¯0.9ç§’ï¼‰
  qRevealId = setTimeout(() => {
    if (!startedAt) return;
    $("resultHint").classList.remove("final");
  $("resultHint").textContent = "å…¥åŠ›ä¸­â€¦ï¼ˆ1å•5ç§’ï¼‰";
    loadNext();
  }, 900);
}

function armQuestionTimer(q){
  clearQuestionTimers();
  const ms = questionLimitMs(q);
  const ref = q;

  qDeadlineAt = performance.now() + ms;
  updateQuestionRemain();

  qTimerId = setTimeout(() => {
    if (!startedAt) return;
    if (current !== ref) return; // ã™ã§ã«æ¬¡ã®å•é¡Œã«ç§»ã£ã¦ã„ãŸã‚‰ç„¡è¦–
    clearQuestionTimers();
    onQuestionTimeout(ref);
  }, ms);
}

function normComboFromEvent(e){
  if (e.key === "Escape") return "Esc";
  if (e.key === "Enter") return "Enter";

  const parts = [];
  if (e.ctrlKey) parts.push("Ctrl");
  if (e.shiftKey) parts.push("Shift");
  if (e.altKey) parts.push("Alt");
  if (e.metaKey) parts.push("Meta");

  let k = e.key;

  // ä¿®é£¾ã‚­ãƒ¼å˜ä½“ï¼ˆAltã ã‘ã¯ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
  // ä¾‹ï¼šAlt â†’ H â†’ H â†’ N ã®ã‚ˆã†ãªãƒªãƒœãƒ³æ“ä½œã‚’ç·´ç¿’ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  if (k === "Alt" && !e.ctrlKey && !e.shiftKey && !e.metaKey) return "Alt";
  if (k === "Control" || k === "Shift" || k === "Meta") return null;
  if (k === "Alt") return null;

  if (k === " ") k = "Space";
  if (k === "Subtract") k = "-";
  if (k === "Add") k = "+";

  if (k === "ArrowUp") k = "â†‘";
  if (k === "ArrowDown") k = "â†“";
  if (k === "ArrowLeft") k = "â†";
  if (k === "ArrowRight") k = "â†’";

  if (k.length === 1) k = k.toUpperCase();

  parts.push(k);
  return parts.join("+");
}


function comboEquals(inputCombo, expectedCombo){
  const a = String(inputCombo ?? "").toLowerCase();
  const b = String(expectedCombo ?? "").toLowerCase();
  if (a === b) return true;

  // ä¾‹ï¼šShift+Alt+=ï¼ˆè¡¨è¨˜ï¼‰ã¨ Shift+Alt++ï¼ˆkeydownã®å®Ÿéš›ã®keyãŒ'+'ã«ãªã‚‹ï¼‰ã‚’åŒä¸€è¦–
  // a/b ã®æœ«å°¾ãŒ "+=" ã®ã¨ãã€æœ«å°¾ã‚’ "+" ã«ç½®æ›ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚è¨±å¯ã™ã‚‹
  if (b.endsWith("+=")) {
    const b2 = b.slice(0, -1) + "+";
    if (a === b2) return true;
  }
  if (a.endsWith("+=")) {
    const a2 = a.slice(0, -1) + "+";
    if (a2 === b) return true;
  }
  return false;
}

function loadNext(){
  if (!startedAt) return;
  clearQuestionTimers();
  $("resultHint").classList.remove("final");
  $("resultHint").textContent = "å…¥åŠ›ä¸­â€¦ï¼ˆ1å•5ç§’ï¼‰";

  if (BANK.length === 0) {
    $("q").textContent = "å•é¡ŒãŒ0ä»¶ã§ã™ï¼ˆEnabledã‚„Stepsã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
    return;
  }

  if (queue.length === 0) queue = shuffle(BANK); // 60ç§’ãªã®ã§ç„¡é™ãƒ«ãƒ¼ãƒ—ã§OK

  current = queue.shift();
  stepIdx = 0;

  $("q").textContent = current.text;
  $("lvl").textContent = `level: ${current.level}`;
  $("prog").textContent = `0/${current.steps.length}`;
  $("res").textContent = "-";
  $("last").textContent = "-";

  armQuestionTimer(current);
}

function start(){
  reset(false);
  try { document.activeElement && document.activeElement.blur(); } catch(e){}

  queue = shuffle(BANK);
  score = 0;
  solved = 0;
  coinCounts[10]=0; coinCounts[15]=0; coinCounts[20]=0; coinCounts[35]=0;

  startedAt = performance.now();

  $("resultHint").classList.remove("final");
  $("resultHint").textContent = "å…¥åŠ›é–‹å§‹â€¦ï¼ˆ60ç§’ï¼‰ / 1å•5ç§’";
  setUI();

  if (timerId) clearInterval(timerId);
  timerId = setInterval(updateRemain, 50);

  if (endTimerId) clearTimeout(endTimerId);
  endTimerId = setTimeout(finish, LIMIT_MS + 20);

  loadNext();
}

function finish(){
  if (!startedAt) return;
  const elapsed = performance.now() - startedAt;

  startedAt = null;
  if (timerId) clearInterval(timerId);
  if (endTimerId) clearTimeout(endTimerId);
  timerId = null;
  endTimerId = null;
  clearQuestionTimers();

  $("remain").textContent = "0";
  $("lvl").textContent = "level: -";
  $("q").textContent = "â° æ™‚é–“åˆ‡ã‚Œï¼";
  $("prog").textContent = "-";
  $("res").innerHTML = `<span class="ok">çµ‚äº†</span>`;
  $("last").textContent = "-";

  const rh = $("resultHint");
  rh.classList.add("final");
  rh.innerHTML =
    `<div class="final-result">`
    + `<div class="row">æ­£è§£æ•° <span class="num mono">${solved}</span></div>`
    + `<div class="row">ã‚¹ã‚³ã‚¢ <span class="num mono">${score}</span><span class="yen-inline">å††</span></div>`
    + `<div class="sub">ãƒ—ãƒ¬ã‚¤æ™‚é–“ <span class="mono">${Math.round(elapsed/1000)}s</span></div>`
    + `</div>`;
}

function reset(resetRemain=true){
  current = null;
  stepIdx = 0;
  queue = [];

  startedAt = null;
  if (timerId) clearInterval(timerId);
  if (endTimerId) clearTimeout(endTimerId);
  timerId = null;
  endTimerId = null;
  clearQuestionTimers();

  score = 0;
  solved = 0;
  coinCounts[10]=0; coinCounts[15]=0; coinCounts[20]=0; coinCounts[35]=0;

  $("q").textContent = "Startã‚’æŠ¼ã—ã¦é–‹å§‹";
  $("lvl").textContent = "level: -";
  $("prog").textContent = "0/0";
  $("res").textContent = "-";
  $("last").textContent = "-";
  $("resultHint").classList.remove("final");
  $("resultHint").textContent = "â€»æ™‚é–“åˆ‡ã‚Œã§è‡ªå‹•çµ‚äº†ã—ã¾ã™ï¼ˆ1å•5ç§’ã§ç­”ãˆè¡¨ç¤ºï¼‰";
  setUI();
  if (resetRemain) $("remain").textContent = "60";
  updateQuestionRemain(); // æœªé–‹å§‹æ™‚ã¯ã€Œ5ã€ã‚’è¡¨ç¤º
}

$("start").addEventListener("click", start);
$("reset").addEventListener("click", () => reset(true));

window.addEventListener("keydown", (e) => {
  if (!startedAt || !current) return;

  const block = (e.key === " " || (typeof e.key === "string" && e.key.startsWith("Arrow")) || e.ctrlKey || e.altKey || e.metaKey);
  if (block) e.preventDefault();

  const combo = normComboFromEvent(e);
  if (!combo) return;

  if (combo === "Esc") {
    $("res").innerHTML = `<span class="ng">ã‚¹ã‚­ãƒƒãƒ—</span>`;
    loadNext();
    return;
  }

  $("last").textContent = combo;

  const expected = current.steps[stepIdx];

  if (comboEquals(combo, expected)) {
    stepIdx++;
    $("prog").textContent = `${stepIdx}/${current.steps.length}`;

    if (stepIdx === current.steps.length) {
      const add = pointsFor(current);
      score += add;
      solved++;
      if (coinCounts[add] != null) coinCounts[add] += 1;
      setUI();
      $("res").innerHTML = `ğŸ£ <span class="ok">æ­£è§£ï¼</span> +${add}`;
      clearQuestionTimers();
      setTimeout(loadNext, 200);
    } else {
      $("res").innerHTML = `<span class="ok">OK</span>`;
    }
  } else {
    $("res").innerHTML = `<span class="ng">é•ã†</span>`;
  }
});

reset();
</script>
</body>
</html>
